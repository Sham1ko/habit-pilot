services:
  d1-db:
    image: node:20-bookworm-slim
    container_name: habit-pilot-d1-db
    working_dir: /workspace
    environment:
      NEXT_TELEMETRY_DISABLED: "1"
      D1_DATABASE_NAME: ${D1_DATABASE_NAME:-habit-pilot}
      CLOUDFLARE_LOAD_DEV_VARS_FROM_DOT_ENV: "false"
    volumes:
      - ./:/workspace
      - d1_node_modules:/workspace/node_modules
      - ./.wrangler/state:/workspace/.wrangler/state
    command:
      - sh
      - -c
      - |
        corepack enable
        pnpm install --frozen-lockfile
        pnpm wrangler d1 migrations apply "$${D1_DATABASE_NAME}" --local
        tail -f /dev/null
    restart: unless-stopped

volumes:
  d1_node_modules:
