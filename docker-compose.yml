services:
  app:
    build:
      context: .
      dockerfile: Dockerfile
    working_dir: /workspace
    ports:
      - "${PORT:-3000}:3000"
    environment:
      NODE_ENV: development
      NEXT_TELEMETRY_DISABLED: "1"
      PORT: 3000
      JWT_SECRET: ${JWT_SECRET:-change-me-at-least-32-characters}
      D1_DATABASE_NAME: ${D1_DATABASE_NAME:-habit-pilot}
      CF_REMOTE_BINDINGS: "false"
      CLOUDFLARE_LOAD_DEV_VARS_FROM_DOT_ENV: "false"
    volumes:
      - app_node_modules:/workspace/node_modules
      - app_next:/workspace/.next
      - ./.wrangler/state:/workspace/.wrangler/state
    develop:
      watch:
        - action: sync
          path: .
          target: /workspace
          ignore:
            - .git/
            - .next/
            - .open-next/
            - .wrangler/
            - node_modules/
            - coverage/
            - dist/
        - action: rebuild
          path: package.json
        - action: rebuild
          path: pnpm-lock.yaml
        - action: rebuild
          path: Dockerfile
    command: ["sh", "./docker/start-app.sh"]
    restart: unless-stopped

volumes:
  app_node_modules:
  app_next:
