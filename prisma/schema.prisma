// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client"
  output   = "../lib/prisma"
}

datasource db {
  provider = "postgresql"
}

// Enums
enum ShareLinkKind {
  public
  ics
}

enum HabitEntryStatus {
  done
  skipped
  micro_done
  recovered
}

// Models
model User {
  id         Int      @id @default(autoincrement())
  email      String   @unique
  name       String?
  tz         String?
  weekly_capacity_cu_default Decimal? @db.Decimal
  created_at DateTime @default(now()) @db.Timestamptz(6)

  habits         Habit[]
  capacity_plans CapacityPlan[]
  share_links    ShareLink[]

  @@map("users")
}

model Habit {
  id              Int      @id @default(autoincrement())
  user_id         Int
  title           String
  description     String?
  weight_cu       Decimal  @db.Decimal
  freq_type       String
  freq_per_week   Decimal  @db.Decimal
  has_micro       Boolean  @default(false)
  micro_title     String?
  micro_weight_cu Decimal  @db.Decimal
  context_tags    String[]
  is_active       Boolean  @default(true)
  created_at      DateTime @default(now()) @db.Timestamptz(6)

  user                User                @relation(fields: [user_id], references: [id], onDelete: Cascade)
  entries             HabitEntry[]
  planned_occurrences PlannedOccurrence[]

  @@map("habits")
}

model HabitEntry {
  id               String           @id @default(uuid()) @db.Uuid
  habit_id         Int              @db.Integer
  date             DateTime         @db.Date
  actual_weight_cu Decimal          @db.Decimal
  status           HabitEntryStatus
  proof_url        String?
  note             String?
  created_at       DateTime         @default(now()) @db.Timestamptz(6)

  habit Habit @relation(fields: [habit_id], references: [id], onDelete: Cascade)

  @@map("habit_entries")
}

model PlannedOccurrence {
  id                String   @id @default(uuid()) @db.Uuid
  habit_id          Int      @db.Integer
  date              DateTime @db.Date
  planned_weight_cu Decimal  @db.Decimal
  context_tag       String?

  habit Habit @relation(fields: [habit_id], references: [id], onDelete: Cascade)

  @@map("planned_occurrences")
}

model CapacityPlan {
  id              String   @id @default(uuid()) @db.Uuid
  user_id         Int      @db.Integer
  week_start_date DateTime @db.Date
  capacity_cu     Decimal  @db.Decimal

  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@map("capacity_plans")
}

model ShareLink {
  id         String        @id @default(uuid()) @db.Uuid
  user_id    Int           @db.Integer
  token      String        @unique
  kind       ShareLinkKind
  is_active  Boolean       @default(true)
  expires_at DateTime?     @db.Timestamptz(6)
  created_at DateTime      @default(now()) @db.Timestamptz(6)

  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@map("share_links")
}
